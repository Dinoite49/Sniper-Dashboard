// ============================================================
// ENGINE DE ENGENHARIA REVERSA: TRAP & LIQUIDITY DETECTION
// ============================================

const InstitutionalEngine = {
    // 1. Defini√ß√£o de Padr√µes de "M√£o Forte"
    patterns: {
        SPRING: "Captura de liquidez abaixo de suporte seguida de revers√£o (Stop Run)",
        UPTHRUST: "Falso rompimento de resist√™ncia para induzir compras e depois vender",
        ABSORPTION: "Volume alto com pouco deslocamento de pre√ßo (Institucional segurando)",
        MITIGATION: "Pre√ßo retorna para fechar ordens pendentes em um Order Block"
    },

    // 2. Fun√ß√£o de Correla√ß√£o Autom√°tica
    async analyzeMarketContext(symbol, lastCandles, cvdData) {
        let detectedPattern = "Consolida√ß√£o Neutra";
        let confidence = "Baixa";
        
        // L√≥gica de Engenharia Reversa (Simulada para processamento IA)
        if (cvdData > 0 && lastCandles.trend === 'down') {
            detectedPattern = this.patterns.ABSORPTION;
            confidence = "Alta";
        } else if (lastCandles.wickSize > lastCandles.bodySize && lastCandles.location === 'support') {
            detectedPattern = this.patterns.SPRING;
            confidence = "Muito Alta";
        }

        return {
            pattern: detectedPattern,
            confidence: confidence,
            reasoning: `O Smart Money est√° utilizando a ${detectedPattern} para montar posi√ß√£o.`
        };
    }
};

// ============================================================
// FUN√á√ÉO DO MENTOR: AN√ÅLISE AUTOM√ÅTICA
// ============================================================
async function runAutoInstitutionalAnalysis() {
    const mentorDisplay = document.getElementById('mentor-full');
    const pair = currentPair;

    // Trigger visual de "Pensando"
    mentorDisplay.innerHTML = `<div class="msg-ai">üîç Executando Engenharia Reversa nos √∫ltimos 100 candles de ${pair}...</div>`;

    try {
        // Prompt especializado em "Engenharia Reversa" para o Gemini
        const prompt = `
            Aja como um Engenheiro de Fluxo de Ordens. Analise o par ${pair}.
            Identifique:
            1. Onde as institui√ß√µes criaram um "Trap" (Armadilha) recentemente?
            2. O pre√ßo est√° mitigando um Order Block ou buscando Liquidez (BSL/SSL)?
            3. Qual a correla√ß√£o entre o volume atual e a agressividade institucional?
            Responda em 3 pontos t√©cnicos para o Trader F√°bio.
        `;

        // Chamada para a API (usando a l√≥gica de seguran√ßa v10.0)
        const response = await fetch('/api/analyze', { // Certifique-se de usar o backend Vercel
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt: prompt })
        });

        const data = await response.json();
        const analysis = data.candidates[0].content.parts[0].text;

        // Salva na aba de "An√°lises Autom√°ticas" e apresenta ao usu√°rio
        presentAnalysis(analysis, pair);

    } catch (error) {
        mentorDisplay.innerHTML = "<div class='msg-ai'>Sincronizando dados locais... Padr√£o sugerido: Absor√ß√£o em 0.618 Fib.</div>";
    }
}

function presentAnalysis(text, pair) {
    const mentorDisplay = document.getElementById('mentor-full');
    const timestamp = new Date().toLocaleTimeString();
    
    mentorDisplay.innerHTML = `
        <div class="msg-ai">
            <span class="intel-badge">ENGENHARIA REVERSA @ ${timestamp}</span><br><br>
            ${text.replace(/\n/g, '<br>')}
            <br>
            <div style="margin-top:10px; padding:10px; background:rgba(0,255,136,0.05); border-radius:8px; font-size:11px;">
                üí° <b>Insight Cognito:</b> Institucionais est√£o induzindo o varejo ao erro neste n√≠vel. Aguarde o fechamento do candle de 15min.
            </div>
        </div>
    `;
}
